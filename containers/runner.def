bootstrap: localimage
From: base.sif
Stage: build

%post
    # Install American dictionary
    apt-get update
    apt-get install -y wamerican
    apt-get clean

%runscript
    echo "Arguments received: $*"
    
    # Create a randomized name
    export NAME1=$(shuf -n1 /usr/share/dict/words)
    export NAME2=$(shuf -n1 /usr/share/dict/words)
    export RUNNER_NAME="${NAME1}-${NAME2}"

    echo "GITHUB_TOKEN=$GITHUB_TOKEN"
    echo "RUNNER_NAME=$RUNNER_NAME"
    echo "Setting up JIT Runner: ${RUNNER_NAME}"

    curl -L \
        -X POST \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${GITHUB_TOKEN}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        https://api.llcad-github-dev.llan.ll.mit.edu/orgs/git-runners/actions/runners/generate-jitconfig \
        -d '{"name":"'${RUNNER_NAME}'","runner_group_id":1,"labels":["self-hosted","X64","ubuntu-latest"],"work_folder":"_work"}'