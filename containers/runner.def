bootstrap: localimage
From: base.sif
Stage: build

%post
    # Install American dictionary
    apt-get update
    apt-get install -y gh wamerican
    apt-get clean

    # Create a folder
    cd $HOME
    mkdir actions-runner && cd actions-runner

    # Download the latest runner package
    curl -O -L https://github.com/actions/runner/releases/download/v2.309.0/actions-runner-linux-x64-2.309.0.tar.gz

    # Extract the installer
    tar xzf ./actions-runner-linux-x64-2.309.0.tar.gz

%runscript

    # Github authentication login
    echo $1 > mytoken.txt
    gh auth login --hostname $HOSTNAME --with-token < mytoken.txt
    rm mytoken.txt

    # Create a unique Github Runner token
    GH_RUNNER_TOKEN=$(gh api \
        --method POST \
        -H "Accept: application/vnd.github+json" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        --hostname "$HOSTNAME" \
        /orgs/"$GH_ORG"/actions/runners/registration-token \
        | jq .token --raw-output)

    # Set variables
    export NAME1=$(shuf -n1 /usr/share/dict/words)
    export NAME2=$(shuf -n1 /usr/share/dict/words)
    export GH_RUNNER_NAME="${NAME1}-${NAME2}"
    export GH_RUNNER_TOKEN="$GH_RUNNER_TOKEN"

    # Display configuration
    echo "Arguments received: $*"
    echo "Hostname (w/o https)  = $HOSTNAME"
    echo "Github Organization   = $GH_ORG"
    echo "Github Runner Name    = $GH_RUNNER_NAME"
    echo "Github Runner Token   = $GH_RUNNER_TOKEN"

    # Configure Runner
    cd $HOME/actions-runner
    ./config.sh \
        --url "https://$HOSTNAME/$GH_ORG" \
        --unattended \
        --token $GH_RUNNER_TOKEN \
        --name $GH_RUNNER_NAME

    ./run.sh
