bootstrap: localimage
From: base.sif
Stage: build

%post
    # Install American dictionary
    apt-get update
    apt-get install -y gh wamerican
    apt-get clean

    # Create a folder
    cd $HOME
    mkdir actions-runner && cd actions-runner

    # Download the latest runner package
    curl -O -L https://github.com/actions/runner/releases/download/v2.309.0/actions-runner-linux-x64-2.309.0.tar.gz

    # Extract the installer
    tar xzf ./actions-runner-linux-x64-2.309.0.tar.gz

%runscript

    # Create a unique Github Runner token
    GH_RUNNER_TOKEN=$(curl    -s \
                    -L \
                    -X POST \
                    -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                    -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" \
                    --url "https://api.llcad-github-dev.llan.ll.mit.edu/orgs/git-runners/actions/runners/registration-token" \
                    | jq .token --raw-output)

    # Set variables
    export NAME1=$(shuf -n1 /usr/share/dict/words)
    export NAME2=$(shuf -n1 /usr/share/dict/words)
    export GH_RUNNER_NAME="${NAME1}-${NAME2}"
    export GH_RUNNER_TOKEN="$GH_RUNNER_TOKEN"

    # Display configuration
    echo "Arguments received: $*"
    echo "Github Personal Token = $GITHUB_TOKEN"
    echo "Github Runner Name    = $GH_RUNNER_NAME"
    echo "Github Runner Token   = $GH_RUNNER_TOKEN"

    # Configure Runner
    cd $HOME/actions-runner
    ./config.sh \
        --url https://llcad-github-dev.llan.ll.mit.edu/git-runners \
        --unattended \
        --token $GH_RUNNER_TOKEN \
        --name $GH_RUNNER_NAME

    ./run.sh

    # Github authentication login
    # echo $GITHUB_TOKEN > mytoken.txt
    # gh auth login -h $1 --with-token < mytoken.txt
    # rm mytoken.txt
